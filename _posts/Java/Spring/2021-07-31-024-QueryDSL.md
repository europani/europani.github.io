---
layout: post
title: QueryDSL
categories: Spring
tags: [Spring, JPA]
---
JPQL을 생성하는 빌더역할을 하는데 코드가 JPQL과 비슷해 가독성이 좋다.  
QueryDSL은 보통 복잡한 SELECT문을 위해 사용한다.

- 쿼리타입(Q) = Q도메인
  - QueryDSL을 사용 하려면 쿼리 타입이라는 쿼리용 클래스가 있어야 한다.
  - 쿼리 타입은 기본 인스턴스를 보관하고 있다. 하지만, 같은 엔티티를 서브쿼리에 사용하면 같은 별칭이 사용되므로 별칭을 직접 지정해야 한다.

```java
@Entity
@Table(name = "member")
public class MemberEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    
    @Column(nullable = false)
    private String name;
}

```
→ QueryDSL은 MemberEntity 동일한 패키지에 `QMemberEntity`라는 이름을 가진 쿼리 타입을 생성한다.

```java
// 기본 인스턴스를 사용하여 쿼리 타입에 접근
QMemberEntity qMember = QMemberEntity.memberEntity;

// 별칭을 직접 지정하여 쿼리 타입에 접근
QMemberEntity qMember = new QMemberEntity("m");      // 생성되는 JPQL의 별칭 = m
```


### 기본 문법
- SELECT문

```java
public void queryDSL() {

    EntityManager em = emf.createEntityManager();

    JPAQuery query = new JPAQuery(em);
    QMemberEntity qMember = QMemberEntity.memberEntity;     // 기본 인스턴스 사용

    // SELECT qMember FROM QMemberEntity qMember WHERE qMember.name=?1
    List<MemberEntity> list = query.from(qMember)
                .where(qMember.name.eq("europani"))
                .list(qMember);     // 출력한 컬럼 선택
}
```


### Spring Data JPA와 QueryDSL 함께 사용하기
QueryDSL은 `JPAQueryFactory` 를 통해 동작한다.

#### (1) `QueryDslRepositorySupport` 상속 받기  
- JPA는 `Repository`, QueryDSL은 `Support` 로 완전 분리하여 사용한다
  
```java
public interface MemberRepository extends JpaRepository<MemberEntity, Integer> {
    
}

@Repository
public class MemberRepositorySupport extends QuerydslRepositorySupport {
    private final JPAQueryFactory queryFactory;
    
    public MemberRepositorySupport(JPAQueryFactory queryFactory) {
        super(MemberEntity.class);
        this.queryFactory = queryFactory;
    }

    public List<MemberEntity> findByName(String name) {
        return queryFactory.selectFrom(memberEntity)
                        .where(memberEntity.name.eq(name))
                        .fetch();
    }
}
```


#### (2) JPARepository에서 QueryDSL 사용하기 (현재사용중)
- `커스텀 Repository`를 사용하여 QueryDSL의 역할을 정의한 다음 JPARepository를 상속받는 `Repository`에 같이 상속 시킨다
- `MemberRepository`에서 JPA 뿐만 아니라 QueryDSL도 사용 할 수 있다 (JPA와 QueryDSL 통합)

##### 1. Custom Repository 인터페이스
- QueryDSL로 만들어 쓸 메서드의 인터페이스

```java
public interface MemberRepositoryCustom {
    List<MemberEntity> findByName(String name);
}
```

##### 2. Repository 인터페이스
- 인터페이스에서 JPA뿐만 아니라 QueryDSL을 위해 만든 Custom 인터페이스까지 상속 받는다

```java
public interface MemberRepository extends JpaRepository<MemberEntity, Integer>, MemberRepositoryCustom {
    
}
```

##### 3. Repository 구현체
- Custom Repository 인터페이스를 구현

```java
@RequiredArgsConstructor
public class MemberRepositoryImpl implements MemberRepositoryCustom {
    private final JPAQueryFactory queryFactory;

    @Override
    public List<MemberEntity> findByName(String name) {
        return queryFactory.selectFrom(memberEntity)
                        .where(memberEntity.name.eq(name))
                        .fetch();
    }
}
```

#### (3) 상속/구현 없는 Repository (이동욱님 추천)
- 어차피 QueryDSL은 `JPAQueryFactory`를 사용하기 때문에 이것만 Repository의 변수로 있으면 된다

```java
@RequiredArgsConstructor
@Repository
public class MemberRepository {
    private final JPAQueryFactory queryFactory;

    public List<MemberEntity> findByName(String name) {
        return queryFactory.selectFrom(memberEntity)
                        .where(memberEntity.name.eq(name))
                        .fetch();
    }
}
```
  


[QuertySQL 레퍼런스(링크)](https://querydsl.com/static/querydsl/4.0.1/reference/ko-KR/html_single/)