---
layout: post
title: JPA
categories: Spring
tags: [Spring, JPA]
---
JPA는 자바 ORM 대한 표준 명세인 인터페이스이다. 그리고 JPA를 구현한 ORM 프레임워크에는 여러가지가 있다.  
JPA 구현체중에 `hibernate`가 가장 일반적이다.

### Entity
- 객체와 테이블 매핑

#### 어노테이션
- @Entity : JPA가 관리하는 클래스  
- @Table : 엔터티와 매핑할 테이블 지정  
<br>

- @Id : 속성 중 기본키  
- @Column : 일반속성  
  - @Column을 사용하지 않으면 변수명과 같은 컬럼명을 사용함
- @Enumerated : 자바의 enum 타입을 맵핑 
  - EnumType.ORDINAL: enum 순서로 저장 (0, 1)
  - EnumType.STRING **(권장)**: enum 이름으로 저장 (ADMIN, USER)
- @Temporal : 날짜 타입을 맵핑  
<br>

- @JoinColumn : 외래키 맵핑
- @ManyToOne : 다대일관계
- @OneToMany : 일대다관계
  - mappedBy : 양방향 맵핑일 경우 반대쪽 맵핑의 필드 이름을 값으로 사용 (mappedBy="team")
- @OneToOne : 일대일관계
- @ManyToMany : 다대다관계 

```java
@Entity
@Table(name = "member")
public class MemberEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    
    @Column(nullable = false)
    private String name;
    
    private String address;

    @Column(name = "zip_code", length = 10)
    private String zipCode;

    @CreationTimestamp 
    private Timestamp createDate;       // insert 시 시간 자동 저장 
    
    @UpdateTimestamp 
    private Timestamp updateDate;       // update 시 시간 자동 저장

    @Enumerated(EnumType.STRING)
    private RoleType roleType;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private TeamEntity team;

    public void setTeam(Team team) {
        this.team = team;
    }

}

@Entity
public class TeamEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    
    @Column(nullable = false)
    private String name;
}

enum RoleType {
    ADMIN, USER
}
```

#### 기본키 매핑
1. 직접 할당 - @Id 사용

2. 자동 생성 - @Id, @GeneratedValue 함께 사용  
 ① IDENTITY : 기본 키 생성을 데이터베이스에 위임  
 ② SEQUENCE : 시퀀스 사용 (`@SequenceGenerator` 사용)  
 ③ TABLE : 시퀀스 생성용 테이블 이용 (`@TableGenerator` 사용)  
 ④ AUTO : 데이터베이스 방언에 따라 자동으로 선택 (Oracle:SEQUENCE / MySQL:IDENTITY)


### 기본 사용법  

|기능|메서드|설명|
|:---:|:---:|:---:|
|목록조회|createQuery(JPQL, Entity.class).getResultList()|엔티티 전체 목록 출력|
|상세조회|find(Entity.class, id)|엔티티 1개 출력|
|생성(Create)|persist(entity)|해당 엔티티 저장|
|수정(Update)|entity.setColumn(value)|해당 엔티티 수정|
|삭제(delete)|remove(entity)|해당 엔티티 삭제|

```java
@Repository
public static void MemberRepository() {

    @PersistenceContext
    EntityManager em;

    // 1. 생성
    public void save(MemberEntity member) {
        em.persist(member);
    }
    

    // 2. 1개 조회
    public MemberEntity findOne(Long id) {
        return em.find(MemberEntity.class, id);
    }

    // 3. 목록 조회
    public List<MemberEntity> findAll() {
        return em.createQuery("SELECT m from MemberEntity m", MemberEntity.class).getResultList();

    // 4. 수정
    public void update(MemberEntity member) {
        MemberEntity findMember = em.find(MemberEntity.class, member,getId());
        findMember.setName("name2");
    }

    // 5. 삭제
    em.remove(member);
    
}

```

### 영속성 컨텍스트(Persistence Context)
- 엔티티를 영구 저장하는 환경
- 엔티티 매니저가 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

#### 엔티티 생애주기
![](https://media.vlpt.us/images/neptunes032/post/ecd3b113-862f-4158-a208-e1eeec92d61d/image.png)

1\. 비영속(New) : 영속성 컨텍스트와 전혀 관계가 없는 상태
   - 엔티티 객체를 생성했지만 영속성 컨텍스트에 저장되지 않은 상태

```java
Member member = new Member();
```

2\. 영속(Managed) : 영속성 컨텍스트에 저장된 상태
   - 엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장된 상태이며 영속성 컨텍스트에 의해 관리됨

```java
em.persist(member);
```

3\. 준영속(Detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
   - 영속성 컨텍스트가 더 이상 엔티티를 관리하지 않는 상태

```java
// 1. 특정 엔티티만 준영속상태로 전환
em.detach(member);
// 2. 영속성 컨텍스트 초기화
em.clear();
// 3. 영속성 컨텍스트 종료
em.close();
```

4\. 삭제(Removed) : 삭제된 상태
   - 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.

```java
em.remove(member);
```
