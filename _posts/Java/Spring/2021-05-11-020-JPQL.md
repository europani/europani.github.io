---
layout: post
title: JPQL
categories: Spring
tags: [Spring, JPA]
---

- JPQL : Java Persistance Query Language  
- JPA에서 복잡한 SELECT문을 수행할 때 모든 데이터를 엔티티 객체로 변환하여 검색하는 것은 불가능하다.
- JPA는 SQL을 추상화한 JPQL이라는 객체 지향 쿼리 언어를 제공한다.
- **엔티티 객체**를 대상으로 한 쿼리
- SELECT절, WHERE, GROUP BY, HAVING, JOIN, ORDER BY, 집합함수 등을 지원

\* 주의사항
- FROM뒤에 엔티티 입력
- JPQL 키워드는 대소문자 구분 X         ex) SELECT = select
- 엔티티와 속성은 대소문자 구분
- 엔티티에 **별명 필수**


### 기본 문법
- SELECT문

```java
String inputName = "europani"

TypeQuery<MemberEntity> query = em.createQuery("SELECT m FROM MemberEntity m WHERE m.name=:username", MemberEntity.class);

query.setParameter("username", inputName);
List<MemberEntity> resultList = query.getResultList();

# 체이닝
List<MemberEntity> resultList = em.createQuery("SELECT m FROM MemberEntity m WHERE m.name=:username", MemberEntity.class)
               .setParameter("username", inputName)
               .getResultList();
```



<hr>

### Spring-data-jpa 
- `@Query`를 사용하여 JPQL을 입력할 수 있다.

```java
@Repository
public interface MemberRepository extends JpaRepository<MemberEntity, Integer> {

     @Query("SELECT m FROM MemberEntity m")
     List<MemberEntity> selectAll();
}

```

#### LEFT JOIN
- 스프링부트 2 버전 부터는 엔티티 클래스 내에 연관관계가 없어도 Left Join이 가능하다

```java
@Entity
public class Member {
    
    @Id
    private String email;
    private String name;
}

@Entity
public class Board {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long bno;
    private String title;
    private String content;

    @ManyToOne(fetch=FetchType.LAZY)
    private Member member;
}

@Entity
public class Reply {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long rno;
    private String text;
    private String replyer;

    @ManyToOne(fetch=FetchType.LAZY)
    private Board board;
}
```
→ Board에서 Member로 접근 가능(연관관계 O) / Member에서 Board로 접근 불가(연관관계 X)  
→ Reply에서 Board로 접근 가능(연관관계 O) / Board에서 Reply로 접근 불가(연관관계 X)

1. 연관관계가 있는 경우

```java
// ex) Board -> Member 접근
@Repository
public interface BoardRepository extends JpaRepository<Board, Long> {

     @Query("SELECT b, m FROM Board b LEFT JOIN b.member m WHERE b.bno=:bno")
     Object getBoardWithWriter(@Param("bno") Long bno);
}
```

2. 연관관계가 없는 경우
   - LEFT JOIN 할 엔티티를 직접 입력하고 `ON` 키워드를 사용하여 연결

```java
// ex) Board -> Reply 접근
@Repository
public interface BoardRepository extends JpaRepository<Board, Long> {

     @Query("SELECT b, r FROM Board b LEFT JOIN Reply r ON r.board=b WHERE b.bno=:bno")
     Object getBoardWithReply(@Param("bno") Long bno);
}
```